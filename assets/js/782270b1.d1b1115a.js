"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3e3],{3054:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"validation-and-testing/environment-validation/efa-validation","title":"EFA and Network Stack Validation","description":"This validation script checks the versions and configuration of the Elastic Fabric Adapter (EFA) network stack, including EFA installer, libfabric, AWS OFI NCCL, NCCL, and CUDA components. This is essential for ensuring optimal network performance in distributed training workloads.","source":"@site/docs/06-validation-and-testing/environment-validation/efa-validation.md","sourceDirName":"06-validation-and-testing/environment-validation","slug":"/validation-and-testing/environment-validation/efa-validation","permalink":"/docs/validation-and-testing/environment-validation/efa-validation","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"EFA and Network Stack Validation","sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"PyTorch Environment Validation","permalink":"/docs/validation-and-testing/environment-validation/pytorch-environment-validation"},"next":{"title":"NCCL & CUDA Validation","permalink":"/docs/category/nccl--cuda-validation"}}');var t=i(4848),r=i(8453);const l={title:"EFA and Network Stack Validation",sidebar_position:2},a="EFA and Network Stack Validation",o={},d=[{value:"Overview",id:"overview",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"For All Clusters",id:"for-all-clusters",level:3},{value:"For Slurm Clusters",id:"for-slurm-clusters",level:3},{value:"For EKS Clusters",id:"for-eks-clusters",level:3},{value:"EFA Version Validation Script",id:"efa-version-validation-script",level:2},{value:"Download and Setup",id:"download-and-setup",level:3},{value:"Script Features",id:"script-features",level:3},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Slurm Implementation",id:"slurm-implementation",level:3},{value:"EKS Implementation",id:"eks-implementation",level:3},{value:"Expected Output",id:"expected-output",level:2},{value:"Version Compatibility Matrix",id:"version-compatibility-matrix",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Common Issues",id:"common-issues",level:3},{value:"Validation Checklist",id:"validation-checklist",level:3},{value:"Performance Recommendations",id:"performance-recommendations",level:2}];function c(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"efa-and-network-stack-validation",children:"EFA and Network Stack Validation"})}),"\n",(0,t.jsx)(e.p,{children:"This validation script checks the versions and configuration of the Elastic Fabric Adapter (EFA) network stack, including EFA installer, libfabric, AWS OFI NCCL, NCCL, and CUDA components. This is essential for ensuring optimal network performance in distributed training workloads."}),"\n",(0,t.jsx)(e.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(e.p,{children:"The EFA validation performs the following checks:"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"EFA installer version verification"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Libfabric version and configuration"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"AWS OFI NCCL plugin version"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"NCCL library version"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"NVIDIA driver and CUDA versions"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Network interface configuration"})}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsx)(e.h3,{id:"for-all-clusters",children:"For All Clusters"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"EFA-enabled instance types (p4d, p5, trn1, etc.)"}),"\n",(0,t.jsx)(e.li,{children:"EFA drivers installed on nodes"}),"\n",(0,t.jsxs)(e.li,{children:["Python 3 with ",(0,t.jsx)(e.code,{children:"prettytable"})," package"]}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"for-slurm-clusters",children:"For Slurm Clusters"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["Access to compute nodes via ",(0,t.jsx)(e.code,{children:"srun"})]}),"\n",(0,t.jsx)(e.li,{children:"Shared filesystem for script distribution"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"for-eks-clusters",children:"For EKS Clusters"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"EFA device plugin deployed"}),"\n",(0,t.jsx)(e.li,{children:"Nodes with EFA interfaces configured"}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"efa-version-validation-script",children:"EFA Version Validation Script"}),"\n",(0,t.jsxs)(e.p,{children:["The EFA validation script is available in the ",(0,t.jsx)(e.a,{href:"https://github.com/aws-samples/awsome-distributed-training/blob/main/4.validation_and_observability/efa-versions.py",children:"awsome-distributed-training repository"}),"."]}),"\n",(0,t.jsx)(e.h3,{id:"download-and-setup",children:"Download and Setup"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# Clone the repository\ngit clone https://github.com/aws-samples/awsome-distributed-training.git\ncd awsome-distributed-training/4.validation_and_observability\n\n# Install dependencies\npip install prettytable\n\n# Make script executable\nchmod +x efa-versions.py\n"})}),"\n",(0,t.jsx)(e.h3,{id:"script-features",children:"Script Features"}),"\n",(0,t.jsxs)(e.p,{children:["The ",(0,t.jsx)(e.code,{children:"efa-versions.py"})," script provides:"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"EFA installer version detection"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Libfabric version checking"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"NCCL version identification"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"AWS OFI NCCL plugin validation"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"NVIDIA driver and CUDA version reporting"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Container vs local version comparison"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.strong,{children:"Detailed EFA interface configuration"})}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,t.jsx)(e.h3,{id:"slurm-implementation",children:"Slurm Implementation"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Install dependencies and run validation"}),":"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# Install Python dependencies\npip install prettytable\n\n# Copy script to shared filesystem\ncp efa-versions.py /fsx/\n\n# Run on all compute nodes\nsrun python3 /fsx/efa-versions.py --detailed\n\n# Run with container comparison\nsrun python3 /fsx/efa-versions.py -c your-training-container:latest\n"})}),"\n",(0,t.jsxs)(e.ol,{start:"2",children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Create Slurm job for systematic validation"}),":"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n#SBATCH -N 2\n#SBATCH --job-name=efa-validation\n#SBATCH --ntasks-per-node=1\n#SBATCH --exclusive\n\necho "EFA Validation Report - $(date)"\necho "Cluster: $(hostname)"\n\n# Run EFA validation\nsrun python3 /fsx/efa-versions.py --detailed\n\n# Test EFA connectivity\necho -e "\\nTesting EFA connectivity..."\nsrun fi_info -p efa -t FI_EP_RDM\n\n# Check EFA bandwidth\necho -e "\\nEFA Interface Details..."\nsrun ibv_devinfo\n'})}),"\n",(0,t.jsx)(e.h3,{id:"eks-implementation",children:"EKS Implementation"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Create validation job"}),":"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-yaml",children:'apiVersion: batch/v1\nkind: Job\nmetadata:\n  name: efa-validation\nspec:\n  template:\n    spec:\n      restartPolicy: Never\n      nodeSelector:\n        node.kubernetes.io/instance-type: "p5.48xlarge"\n      containers:\n      - name: efa-validator\n        image: ubuntu:22.04\n        command: ["/bin/bash"]\n        args:\n        - -c\n        - |\n          apt-get update && apt-get install -y python3 python3-pip\n          pip3 install prettytable\n          python3 /scripts/efa-versions.py --detailed\n        resources:\n          limits:\n            vpc.amazonaws.com/efa: 32\n          requests:\n            vpc.amazonaws.com/efa: 32\n        volumeMounts:\n        - name: efa-script\n          mountPath: /scripts\n      volumes:\n      - name: efa-script\n        configMap:\n          name: efa-validation-script\n'})}),"\n",(0,t.jsxs)(e.ol,{start:"2",children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"Deploy and run"}),":"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# Create ConfigMap with script\nkubectl create configmap efa-validation-script --from-file=efa-versions.py\n\n# Apply job\nkubectl apply -f efa-validation-job.yaml\n\n# Check results\nkubectl logs -l job-name=efa-validation\n"})}),"\n",(0,t.jsx)(e.h2,{id:"expected-output",children:"Expected Output"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"EFA and Network Stack Validation\n==================================================\n+---------------+----------------+\n| Component     | Version        |\n+---------------+----------------+\n| EFA Installer | 1.31.0         |\n| Libfabric     | 1.18.2         |\n| NCCL          | 2.20.3         |\n| AWS OFI NCCL  | 1.8.1-aws      |\n| NVIDIA Driver | 535.183.01     |\n| CUDA          | 12.1.105       |\n+---------------+----------------+\n\n============================================================\n EFA Configuration Check\n============================================================\nEFA Interfaces Found: 32\n  Interface 0: rdmap0s29-rdm\n  Interface 1: rdmap1s29-rdm\n  ...\nInfiniBand devices: rdma_cm, uverbs0, uverbs1, ...\nEFA kernel module: Loaded\n"})}),"\n",(0,t.jsx)(e.h2,{id:"version-compatibility-matrix",children:"Version Compatibility Matrix"}),"\n",(0,t.jsxs)(e.table,{children:[(0,t.jsx)(e.thead,{children:(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.th,{children:"EFA Installer"}),(0,t.jsx)(e.th,{children:"AWS OFI NCCL"}),(0,t.jsx)(e.th,{children:"NCCL"}),(0,t.jsx)(e.th,{children:"Recommended Use Case"})]})}),(0,t.jsxs)(e.tbody,{children:[(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"1.31.0"}),(0,t.jsx)(e.td,{children:"v1.8.1-aws"}),(0,t.jsx)(e.td,{children:"2.20.3"}),(0,t.jsx)(e.td,{children:"Latest features"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"1.30.0"}),(0,t.jsx)(e.td,{children:"v1.7.3-aws"}),(0,t.jsx)(e.td,{children:"2.18.5"}),(0,t.jsx)(e.td,{children:"Stable production"})]}),(0,t.jsxs)(e.tr,{children:[(0,t.jsx)(e.td,{children:"1.29.1"}),(0,t.jsx)(e.td,{children:"v1.7.2-aws"}),(0,t.jsx)(e.td,{children:"2.18.3"}),(0,t.jsx)(e.td,{children:"Legacy support"})]})]})]}),"\n",(0,t.jsx)(e.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(e.h3,{id:"common-issues",children:"Common Issues"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"EFA interfaces not found"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# Check if EFA is enabled on instance type\ncurl -s http://169.254.169.254/latest/meta-data/network/interfaces/macs/ | \\\nxargs -I {} curl -s http://169.254.169.254/latest/meta-data/network/interfaces/macs/{}/interface-type\n"})}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"AWS OFI NCCL not found"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'# Check installation path\nfind /opt -name "*ofi*" -type d 2>/dev/null\nfind /usr -name "*nccl-net*" 2>/dev/null\n'})}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.strong,{children:"Version mismatches"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Ensure container and host have compatible versions"}),"\n",(0,t.jsx)(e.li,{children:"Check for multiple NCCL installations"}),"\n",(0,t.jsx)(e.li,{children:"Verify EFA installer completed successfully"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"validation-checklist",children:"Validation Checklist"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u2705 EFA installer version matches expected"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 Libfabric is properly installed and configured"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 AWS OFI NCCL plugin is available"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 NCCL version is compatible with PyTorch"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 EFA interfaces are detected and accessible"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 NVIDIA drivers are up to date"}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"performance-recommendations",children:"Performance Recommendations"}),"\n",(0,t.jsx)(e.p,{children:"Based on validation results:"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"For P5 instances"}),": Use EFA installer 1.31.0+ with AWS OFI NCCL v1.8.1+"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"For P4d instances"}),": EFA installer 1.29.1+ is sufficient"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"For Trainium"}),": Ensure Neuron SDK compatibility with EFA versions"]}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(c,{...n})}):c(n)}},8453:(n,e,i)=>{i.d(e,{R:()=>l,x:()=>a});var s=i(6540);const t={},r=s.createContext(t);function l(n){const e=s.useContext(r);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:l(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);