"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2345],{4318:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"Tips/Slurm/bastion-host","title":"Bastion Host","description":"Ok so what if we want to access our cluster with normal ssh and not ssm?","source":"@site/docs/08-Tips/Slurm/04-bastion-host.md","sourceDirName":"08-Tips/Slurm","slug":"/Tips/Slurm/bastion-host","permalink":"/ai-on-sagemaker-hyperpod/docs/Tips/Slurm/bastion-host","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Bastion Host","weight":44},"sidebar":"tutorialSidebar","previous":{"title":"Troubleshooting","permalink":"/ai-on-sagemaker-hyperpod/docs/Tips/Slurm/troubleshooting"},"next":{"title":"Login Node","permalink":"/ai-on-sagemaker-hyperpod/docs/Tips/Slurm/login-node"}}');var o=n(4848),i=n(8453);const r={title:"Bastion Host",weight:44},a=void 0,c={},l=[];function u(e){const s={a:"a",blockquote:"blockquote",code:"code",em:"em",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(s.blockquote,{children:["\n",(0,o.jsxs)(s.p,{children:["Ok so what if we want to access our cluster with ",(0,o.jsx)(s.em,{children:"normal ssh"})," and not ssm?"]}),"\n"]}),"\n",(0,o.jsxs)(s.p,{children:["To do that we need to use a bastion host, this host runs in the same VPC as your filesystem however it's in the ",(0,o.jsx)(s.em,{children:"Public Subnet"})," so that you can SSH into the host."]}),"\n",(0,o.jsxs)(s.p,{children:["Make sure you're in your ",(0,o.jsx)(s.em,{children:"Local Environment"}),":"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"exit # exit the cluster to local environment\n"})}),"\n",(0,o.jsxs)(s.ol,{children:["\n",(0,o.jsxs)(s.li,{children:["Spin up a new t3 instance running ",(0,o.jsx)(s.em,{children:"Ubuntu 20.04"})," in the ",(0,o.jsx)(s.em,{children:"Public Subnet"})," we created in ",(0,o.jsx)(s.a,{href:"/ai-on-sagemaker-hyperpod/docs/getting-started/orchestrated-by-slurm/initial-cluster-setup",children:"0. Prerequisites"}),":"]}),"\n"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"# create keypair if it doesn't exist and import it\nif [ -f $HOME/.ssh/id_rsa.pub ]; then\n    aws ec2 import-key-pair --key-name ssh_key --public-key-material fileb://$HOME/.ssh/id_rsa.pub\nelse\n    ssh-keygen -t rsa -q -f \"$HOME/.ssh/id_rsa\" -N \"\"\n    aws ec2 import-key-pair --key-name ssh_key --public-key-material fileb://$HOME/.ssh/id_rsa.pub\nfi\n\nsource env_vars\nubuntu_ami=$(aws ssm get-parameters --names /aws/service/canonical/ubuntu/server/20.04/stable/current/amd64/hvm/ebs-gp2/ami-id | jq '.Parameters[0].Value' | tr -d '\"')\n\n# launch the instance\naws ec2 run-instances \\\n    --image-id ${ubuntu_ami} \\\n    --instance-type t3.small \\\n    --key-name ssh_key \\\n    --security-group-ids ${SECURITY_GROUP} \\\n    --subnet-id ${PUBLIC_SUBNET_ID} \\\n    --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=bastion}]'\n"})}),"\n",(0,o.jsxs)(s.ol,{start:"2",children:["\n",(0,o.jsxs)(s.li,{children:["Next add this jump host info to your ",(0,o.jsx)(s.code,{children:"~/.ssh/config"})]}),"\n"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"# grab the public ip from the following command:\npublic_ip=$(aws ec2 describe-instances --filters 'Name=tag:Name,Values=bastion' --query 'Reservations[*].Instances[*].PublicIpAddress' --output text)\n\n# add the hostname to the ~/.ssh/config\ncat <<EOF >> ~/.ssh/config\nHost bastion\n  User ubuntu\n  Hostname ${public_ip}\nEOF\n"})}),"\n",(0,o.jsx)(s.p,{children:"Next modify your security group to allow SSH traffic:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"aws ec2 authorize-security-group-ingress \\\n    --group-id ${SECURITY_GROUP} \\\n    --protocol tcp \\\n    --port 22 \\\n    --cidr 0.0.0.0/32\n"})}),"\n",(0,o.jsx)(s.p,{children:"Confirm that you can ssh in:"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"ssh bastion\n# then exit back to local environment\nexit\n"})}),"\n",(0,o.jsxs)(s.ol,{start:"3",children:["\n",(0,o.jsxs)(s.li,{children:["Next we're going to mount the ",(0,o.jsx)(s.code,{children:"/fsx"})," filesystem from the cluster, in order to do this we'll need to first ",(0,o.jsx)(s.a,{href:"https://docs.aws.amazon.com/fsx/latest/LustreGuide/install-lustre-client.html#lustre-client-ubuntu",children:"install Lustre client"}),":"]}),"\n"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"wget -O - https://fsx-lustre-client-repo-public-keys.s3.amazonaws.com/fsx-ubuntu-public-key.asc | gpg --dearmor | sudo tee /usr/share/keyrings/fsx-ubuntu-public-key.gpg >/dev/null\nsudo bash -c 'echo \"deb [signed-by=/usr/share/keyrings/fsx-ubuntu-public-key.gpg] https://fsx-lustre-client-repo.s3.amazonaws.com/ubuntu focal main\" > /etc/apt/sources.list.d/fsxlustreclientrepo.list && apt-get update'\nsudo apt install -y lustre-client-modules-$(uname -r)\n"})}),"\n",(0,o.jsxs)(s.ol,{start:"4",children:["\n",(0,o.jsxs)(s.li,{children:["Next, navigate to the ",(0,o.jsx)(s.a,{href:"https://console.aws.amazon.com/fsx/home?",children:"FSx Console"})," and click on your fsx filesystem. Click attach to get the mount commands. They will look similar to the following:"]}),"\n"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{children:"sudo mkdir /fsx\nsudo mount -t lustre -o relatime,flock fs-007d09da6ab2684eg.fsx.us-west-2.amazonaws.com@tcp:/4gb3nbem /fsx\n"})}),"\n",(0,o.jsxs)(s.ol,{start:"5",children:["\n",(0,o.jsxs)(s.li,{children:["Next we need to re-map ",(0,o.jsx)(s.code,{children:"ubuntu"})," to ",(0,o.jsx)(s.code,{children:"/fsx/ubuntu"})," so we can ssh directly into the bastion:"]}),"\n"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"# allow ssh to root user temporarily:\nsudo cp /home/ubuntu/.ssh/authorized_keys /root/.ssh/authorized_keys\nexit # go back to local machine\n# ssh into root directly\nssh root@bastion\n# move the directory to the fsx directory, this adds the correct ssh key to access the cluster:\nusermod -d /fsx/ubuntu ubuntu\nrm /root/.ssh/authorized_keys\nexit\n"})}),"\n",(0,o.jsxs)(s.ol,{start:"6",children:["\n",(0,o.jsxs)(s.li,{children:["Next add the cluster's private ip address to your local ssh config. To do this we'll connect to the cluster and grab the ip address then exit and add it to our ",(0,o.jsx)(s.em,{children:"local"})," ~/.ssh/config."]}),"\n"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"# grab the private ip address:\nAdmin:~ $ ./easy-ssh.sh -c controller-machine ml-cluster\n....\nroot@ip-10-1-100-227:/usr/bin# hostname -I\n10.1.84.107 169.254.0.1\nroot@ip-10-1-100-227:/usr/bin# exit\n\n# add the ip to the ~/.ssh/config where 10.1.84.107 is the ip from hostname -I\ncat <<EOF >> ~/.ssh/config\nHost ml-cluster\n  User ubuntu\n  Hostname 10.1.84.107\nEOF\n"})}),"\n",(0,o.jsxs)(s.ol,{start:"5",children:["\n",(0,o.jsx)(s.li,{children:"Now we can ssh into this host and use it as a jump host with the command:"}),"\n"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-bash",children:"ssh -J bastion ml-cluster\n"})}),"\n",(0,o.jsx)(s.p,{children:"Voila! in the next section we'll show an alternate way to use SSM to connect similar to SSH."})]})}function h(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,o.jsx)(s,{...e,children:(0,o.jsx)(u,{...e})}):u(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>r,x:()=>a});var t=n(6540);const o={},i=t.createContext(o);function r(e){const s=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),t.createElement(i.Provider,{value:s},e.children)}}}]);