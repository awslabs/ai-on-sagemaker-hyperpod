"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[676],{1596:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"add-ons/Observability/MLFlow/MLFlow","title":"SageMaker Managed MLflow","description":"Amazon SageMaker offers a managed MLflow capability for machine learning (ML) and generative AI experimentation. This capability makes it easy for data scientists to use MLflow on SageMaker for model training, registration, and deployment. Admins can quickly set up secure and scalable MLflow environments on AWS. Data scientists and ML developers can efficiently track ML experiments and find the right model for a business problem.","source":"@site/docs/04-add-ons/Observability/MLFlow/MLFlow.md","sourceDirName":"04-add-ons/Observability/MLFlow","slug":"/add-ons/Observability/MLFlow/","permalink":"/docs/add-ons/Observability/MLFlow/","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"Amazon CloudWatch Container Insights (EKS only)","permalink":"/docs/add-ons/Observability/Container Insights/"},"next":{"title":"Weights & Biases","permalink":"/docs/add-ons/Observability/Weights and Biases/"}}');var t=a(4848),s=a(8453);const i={sidebar_position:5},o="SageMaker Managed MLflow",l={},c=[{value:"Core components of managed MLflow on SageMaker",id:"core-components-of-managed-mlflow-on-sagemaker",level:2},{value:"Create MlFlow Tracking Server",id:"create-mlflow-tracking-server",level:2},{value:"Setup Mlflow Access in EKS.",id:"setup-mlflow-access-in-eks",level:2},{value:"1. Install MLflow and the AWS MLflow plugin",id:"1-install-mlflow-and-the-aws-mlflow-plugin",level:3},{value:"2. Add Service account to job spec file",id:"2-add-service-account-to-job-spec-file",level:3},{value:"2. Connect to your MLflow Tracking Server",id:"2-connect-to-your-mlflow-tracking-server",level:3},{value:"3. Log metrics",id:"3-log-metrics",level:3},{value:"4. View the experiments in tracking server",id:"4-view-the-experiments-in-tracking-server",level:3}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"sagemaker-managed-mlflow",children:"SageMaker Managed MLflow"})}),"\n",(0,t.jsx)(n.p,{children:"Amazon SageMaker offers a managed MLflow capability for machine learning (ML) and generative AI experimentation. This capability makes it easy for data scientists to use MLflow on SageMaker for model training, registration, and deployment. Admins can quickly set up secure and scalable MLflow environments on AWS. Data scientists and ML developers can efficiently track ML experiments and find the right model for a business problem."}),"\n",(0,t.jsx)(n.h2,{id:"core-components-of-managed-mlflow-on-sagemaker",children:"Core components of managed MLflow on SageMaker"}),"\n",(0,t.jsx)(n.p,{children:"The fully managed MLflow capability on SageMaker is built around three core components:"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"MLflow Tracking Server"})," \u2013 With just a few steps, you can create an MLflow Tracking Server through the SageMaker Studio UI. This stand-alone HTTP server serves multiple REST API endpoints for tracking runs and experiments, enabling you to begin monitoring your ML experiments efficiently. For more granular security customization, you can also use the AWS Command Line Interface (AWS CLI)."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"MLflow backend metadata store"})," \u2013 The metadata store is a critical part of the MLflow Tracking Server, where all metadata related to experiments, runs, and artifacts is persisted. This includes experiment names, run IDs, parameter values, metrics, tags, and artifact locations, ensuring comprehensive tracking and management of your ML experiments."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"MLflow artifact store"})," \u2013 This component provides a storage location for all artifacts generated during ML experiments, such as trained models, datasets, logs, and plots. Utilizing an Amazon Simple Storage Service (Amazon S3) bucket, it offers a customer-managed AWS account for storing these artifacts securely and efficiently."]}),"\n",(0,t.jsx)("div",{className:"text--center",children:(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"mflow diagram",src:a(4737).A+"",width:"841",height:"620"})})}),"\n",(0,t.jsx)(n.h1,{id:"setup-mlflow-tracking-server-on-sagemaker",children:"Setup MLflow tracking server on SageMaker"}),"\n",(0,t.jsx)(n.p,{children:"Use MLflow with Amazon SageMaker to track, organize, view, analyze, and compare iterative ML experimentation to gain comparative insights and register and deploy your best performing models. To configure Mlflow we need to create a tracking server and then configure EKS cluster to use it."}),"\n",(0,t.jsx)(n.h2,{id:"create-mlflow-tracking-server",children:"Create MlFlow Tracking Server"}),"\n",(0,t.jsx)(n.p,{children:"To create tracking server please refer to the below Amazon SageMaker documentation"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/sagemaker/latest/dg/mlflow-create-tracking-server.html",children:"Create an MlFlow tracking server"})}),"\n",(0,t.jsx)(n.h2,{id:"setup-mlflow-access-in-eks",children:"Setup Mlflow Access in EKS."}),"\n",(0,t.jsx)(n.p,{children:"We will create a service account with IAM permissions required to access the tracking server which can be used to track metrics."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Create an IAM OIDC identity provider for your cluster with the following command:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"eksctl utils associate-iam-oidc-provider --cluster $EKS_CLUSTER_NAME --approve\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:"Create an IAM policy"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'cat <<EOF> mlflowpolicy.json\n{\n    "Version": "2012-10-17",    \n    "Statement": [        \n        {            \n            "Effect": "Allow",            \n            "Action": [\n                "sagemaker-mlflow:*",\n                "sagemaker:CreateMlflowTrackingServer",\n                "sagemaker:UpdateMlflowTrackingServer",\n                "sagemaker:DeleteMlflowTrackingServer",\n                "sagemaker:StartMlflowTrackingServer",\n                "sagemaker:StopMlflowTrackingServer",\n                "sagemaker:CreatePresignedMlflowTrackingServerUrl"\n            ],            \n            "Resource": "*"        \n        }        \n    ]\n}\nEOF\n\naws iam create-policy \\\n    --policy-name SageMakerMlFlowAccessPolicy \\\n    --policy-document file://mlflowpolicy.json\n'})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsx)(n.li,{children:"Create an IAM role"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"To Access MLFlow tracking server we need to create an IAM service account with a role that uses the above created policy. This section shows how to create an IAM role to delegate these permissions. To create this role we will use eksctl."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"ROLE_NAME=SM_MLFLOW_ACCESS_ROLE\nPOLICY_ARN=$(aws iam list-policies --query 'Policies[?PolicyName==`SageMakerMlFlowAccessPolicy`]' | jq '.[0].Arn' |  tr -d '\"')\n\neksctl create iamserviceaccount \\\n    --name sagemaker-mlflow-sa \\\n    --namespace kubeflow \\\n    --cluster $EKS_CLUSTER_NAME \\\n    --attach-policy-arn $POLICY_ARN \\\n    --approve \\\n    --role-name $ROLE_NAME \\\n    --region $AWS_REGION \\\n"})}),"\n",(0,t.jsx)(n.h1,{id:"track-experiments-with-mlflow",children:"Track experiments with Mlflow"}),"\n",(0,t.jsx)(n.p,{children:"Amazon SageMaker uses an MLflow plugin to customize the behavior of the MLflow Python client and integrate AWS tooling. The AWS MLflow plugin authenticates API calls made with MLflow using AWS Signature Version 4. The AWS MLflow plugin allows you to connect to your MLflow tracking server using the tracking server ARN. For more information about plugins, see MLflow Plugins in the MLflow documentation."}),"\n",(0,t.jsx)(n.h3,{id:"1-install-mlflow-and-the-aws-mlflow-plugin",children:"1. Install MLflow and the AWS MLflow plugin"}),"\n",(0,t.jsx)(n.p,{children:"When building the docker image for your application install the below dependencies"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"pip install mlflow==2.13.2 sagemaker-mlflow==0.1.0 \n"})}),"\n",(0,t.jsx)(n.h3,{id:"2-add-service-account-to-job-spec-file",children:"2. Add Service account to job spec file"}),"\n",(0,t.jsx)(n.p,{children:"We need to add the service account created in the previous step to the job spec in order to assume the mlflow permissions as shown below"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"spec:\n     serviceAccountName: sagemaker-mlflow-sa\n"})}),"\n",(0,t.jsx)(n.h3,{id:"2-connect-to-your-mlflow-tracking-server",children:"2. Connect to your MLflow Tracking Server"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'import mlflow\n\narn = "YOUR-TRACKING-SERVER-ARN"\nmlflow.set_tracking_uri(arn)\n\n'})}),"\n",(0,t.jsx)(n.h3,{id:"3-log-metrics",children:"3. Log metrics"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'with mlflow.start_run():\n    mlflow.log_metric("foo", 1)\n    \nprint(mlflow.search_runs())\n'})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["For more detailed info on tracking metrics , refer the documentation ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/sagemaker/latest/dg/mlflow-track-experiments-log-metrics.html",children:"here"})]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"4-view-the-experiments-in-tracking-server",children:"4. View the experiments in tracking server"}),"\n",(0,t.jsxs)(n.p,{children:["You can view the tracked metrics in the tracking server managed by Amazon SageMaker. To generate an URI for access the tracking server UI refer the documentation ",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/sagemaker/latest/dg/mlflow-launch-ui.html",children:"here"})]})]})}function m(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},4737:(e,n,a)=>{a.d(n,{A:()=>r});const r=a.p+"assets/images/mlflow-31cf40928df0011538bbc56a52152066.png"},8453:(e,n,a)=>{a.d(n,{R:()=>i,x:()=>o});var r=a(6540);const t={},s=r.createContext(t);function i(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);