"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[7050],{2778:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"getting-started/orchestrated-by-eks/Set up an Amazon S3 mountpoint","title":"Set up an Amazon S3 mountpoint","description":"With the Mountpoint for Amazon S3 Container Storage Interface (CSI) driver, your Kubernetes applications can access Amazon S3 objects through a file system interface, achieving high aggregate throughput without changing any application code. Built on Mountpoint for Amazon S3, the CSI driver presents an Amazon S3 bucket as a volume that can be accessed by containers in Amazon EKS and self-managed Kubernetes clusters. This section shows you how to deploy the Mountpoint for Amazon S3 CSI driver to your Amazon EKS cluster.","source":"@site/docs/00-getting-started/orchestrated-by-eks/Set up an Amazon S3 mountpoint.md","sourceDirName":"00-getting-started/orchestrated-by-eks","slug":"/getting-started/orchestrated-by-eks/Set up an Amazon S3 mountpoint","permalink":"/docs/getting-started/orchestrated-by-eks/Set up an Amazon S3 mountpoint","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"title":"Set up an Amazon S3 mountpoint","sidebar_position":8},"sidebar":"tutorialSidebar","previous":{"title":"Adding a Data Repository Association","permalink":"/docs/getting-started/orchestrated-by-eks/Adding a Data Repository Assocation"},"next":{"title":"Orchestrated by SLURM","permalink":"/docs/category/orchestrated-by-slurm"}}');var s=t(4848),a=t(8453);const i={title:"Set up an Amazon S3 mountpoint",sidebar_position:8},r=void 0,c={},l=[{value:"Considerations",id:"considerations",level:4},{value:"Setup Mountpoint for Amazon S3",id:"setup-mountpoint-for-amazon-s3",level:4},{value:"Configure Mountpoint for Amazon S3",id:"configure-mountpoint-for-amazon-s3",level:4},{value:"Mount s3 bucket to Pod",id:"mount-s3-bucket-to-pod",level:4}];function u(e){const n={code:"code",div:"div",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"With the Mountpoint for Amazon S3 Container Storage Interface (CSI) driver, your Kubernetes applications can access Amazon S3 objects through a file system interface, achieving high aggregate throughput without changing any application code. Built on Mountpoint for Amazon S3, the CSI driver presents an Amazon S3 bucket as a volume that can be accessed by containers in Amazon EKS and self-managed Kubernetes clusters. This section shows you how to deploy the Mountpoint for Amazon S3 CSI driver to your Amazon EKS cluster."}),"\n",(0,s.jsx)(n.div,{children:(0,s.jsx)(n.p,{children:"Make sure that your S3 bucket is located in the same Region (and Availability Zone for S3 Express One Zone) as your compute nodes. Accessing S3 bucket in a different Region or Availability Zone will result in reduced I/O performance and increased network costs."})}),"\n",(0,s.jsx)(n.h4,{id:"considerations",children:"Considerations"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"The Mountpoint for Amazon S3 CSI driver supports only static provisioning. Dynamic provisioning, or creation of new buckets, isn't supported."}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"setup-mountpoint-for-amazon-s3",children:"Setup Mountpoint for Amazon S3"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Create an IAM OIDC identity provider for your cluster with the following command:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"eksctl utils associate-iam-oidc-provider --cluster $EKS_CLUSTER_NAME --approve\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"Create an IAM policy"}),"\n"]}),"\n",(0,s.jsx)(n.div,{children:"Replace DOC-EXAMPLE-BUCKET1 with your own Amazon S3 bucket name."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'cat <<EOF> s3accesspolicy.json\n{\n   "Version": "2012-10-17",\n   "Statement": [\n        {\n            "Sid": "MountpointFullBucketAccess",\n            "Effect": "Allow",\n            "Action": [\n                "s3:ListBucket"\n            ],\n            "Resource": [\n                "arn:aws:s3:::DOC-EXAMPLE-BUCKET1"\n            ]\n        },\n        {\n            "Sid": "MountpointFullObjectAccess",\n            "Effect": "Allow",\n            "Action": [\n                "s3:GetObject",\n                "s3:PutObject",\n                "s3:AbortMultipartUpload",\n                "s3:DeleteObject"\n            ],\n            "Resource": [\n                "arn:aws:s3:::DOC-EXAMPLE-BUCKET1/*"\n            ]\n        }\n   ]\n}\nEOF\n\naws iam create-policy \\\n    --policy-name S3MountpointAccessPolicy \\\n    --policy-document file://s3accesspolicy.json\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"Create an IAM role"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The Mountpoint for Amazon S3 CSI driver requires Amazon S3 permissions to interact with your file system. This section shows how to create an IAM role to delegate these permissions. To create this role we will use eksctl."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"ROLE_NAME=SM_HP_S3_CSI_ROLE\nPOLICY_ARN=$(aws iam list-policies --query 'Policies[?PolicyName==`S3MountpointAccessPolicy`]' | jq '.[0].Arn' |  tr -d '\"')\n\neksctl create iamserviceaccount \\\n    --name s3-csi-driver-sa \\\n    --namespace kube-system \\\n    --cluster $EKS_CLUSTER_NAME \\\n    --attach-policy-arn $POLICY_ARN \\\n    --approve \\\n    --role-name $ROLE_NAME \\\n    --region $AWS_REGION \\\n    --role-only\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:"Install the Mountpoint for Amazon S3 CSI driver"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"ROLE_ARN=$(aws iam get-role --role-name $ROLE_NAME  --query 'Role.Arn' --output text)\n\neksctl create addon --name aws-mountpoint-s3-csi-driver --cluster $EKS_CLUSTER_NAME --service-account-role-arn $ROLE_ARN --force\n"})}),"\n",(0,s.jsx)(n.h4,{id:"configure-mountpoint-for-amazon-s3",children:"Configure Mountpoint for Amazon S3"}),"\n",(0,s.jsx)(n.p,{children:"Create a persistent volume. Replace the bucket name with the actual bucket."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cat <<EOF> pv_s3.yaml\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: s3-pv\nspec:\n  capacity:\n    storage: 1200Gi # ignored, required\n  accessModes:\n    - ReadWriteMany # supported options: ReadWriteMany / ReadOnlyMany\n  mountOptions:\n    - allow-delete\n    - region $AWS_REGION\n    - prefix /\n  csi:\n    driver: s3.csi.aws.com # required\n    volumeHandle: s3-csi-driver-volume\n    volumeAttributes:\n      bucketName: DOC-EXAMPLE-BUCKET1\nEOF\n\nkubectl apply -f pv_s3.yaml\n"})}),"\n",(0,s.jsx)(n.p,{children:"Create a persistent volume claim"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'cat <<EOF> pvc_s3.yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: s3-claim\nspec:\n  accessModes:\n    - ReadWriteMany # supported options: ReadWriteMany / ReadOnlyMany\n  storageClassName: "" # required for static provisioning\n  resources:\n    requests:\n      storage: 1200Gi # ignored, required\n  volumeName: s3-pv\nEOF\n\nkubectl apply -f pvc_s3.yaml\n'})}),"\n",(0,s.jsx)(n.h4,{id:"mount-s3-bucket-to-pod",children:"Mount s3 bucket to Pod"}),"\n",(0,s.jsx)(n.p,{children:"Below example shows how to mount the s3 bucket as a volume to container."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'apiVersion: v1\nkind: Pod\nmetadata:\n  name: s3-app\nspec:\n  containers:\n    - name: app\n      image: ubuntu\n      command: ["/bin/sh"]\n      args: ["-c", "echo \'Hello from the container!\' >> /data/$(date -u).txt; tail -f /dev/null"]\n      volumeMounts:\n        - name: persistent-storage\n          mountPath: /data\n  volumes:\n    - name: persistent-storage\n      persistentVolumeClaim:\n        claimName: s3-claim\n'})})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>r});var o=t(6540);const s={},a=o.createContext(s);function i(e){const n=o.useContext(a);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(a.Provider,{value:n},e.children)}}}]);