"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2949],{5251:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"getting-started/orchestrated-by-eks/Set up your shared file system","title":"Set up your shared file system","description":"Why Shared File Systems Matter","source":"@site/docs/00-getting-started/orchestrated-by-eks/Set up your shared file system.md","sourceDirName":"00-getting-started/orchestrated-by-eks","slug":"/getting-started/orchestrated-by-eks/Set up your shared file system","permalink":"/docs/getting-started/orchestrated-by-eks/Set up your shared file system","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"title":"Set up your shared file system","sidebar_position":6},"sidebar":"tutorialSidebar","previous":{"title":"Additional Information","permalink":"/docs/getting-started/orchestrated-by-eks/additional-information"},"next":{"title":"Adding a Data Repository Association","permalink":"/docs/getting-started/orchestrated-by-eks/Adding a Data Repository Assocation"}}');var t=n(4848),r=n(8453);const a={title:"Set up your shared file system",sidebar_position:6},o="Shared File System Setup for SageMaker HyperPod (EKS)",l={},c=[{value:"Why Shared File Systems Matter",id:"why-shared-file-systems-matter",level:2},{value:"Performance Impact",id:"performance-impact",level:3},{value:"FSx for Lustre Benefits",id:"fsx-for-lustre-benefits",level:3},{value:"Setup Options",id:"setup-options",level:2},{value:"Option 1: Auto-Provisioned (Console Quick Setup)",id:"option-1-auto-provisioned-console-quick-setup",level:3},{value:"What Gets Created Automatically",id:"what-gets-created-automatically",level:4},{value:"Verification Steps",id:"verification-steps",level:4},{value:"Option 2: Manual Setup (Dynamic Provisioning)",id:"option-2-manual-setup-dynamic-provisioning",level:3},{value:"When to Use Manual Setup",id:"when-to-use-manual-setup",level:4},{value:"Install the Amazon FSx for Lustre CSI Driver",id:"install-the-amazon-fsx-for-lustre-csi-driver",level:4},{value:"Step-by-Step Setup",id:"step-by-step-setup",level:4},{value:"Option 3: Bring Your Own FSx (Static Provisioning)",id:"option-3-bring-your-own-fsx-static-provisioning",level:3},{value:"Requirements and Considerations",id:"requirements-and-considerations",level:4},{value:"Integration Steps",id:"integration-steps",level:4},{value:"Using FSx in EKS Jobs",id:"using-fsx-in-eks-jobs",level:2},{value:"Mount Points and Paths",id:"mount-points-and-paths",level:3},{value:"Best Practices for Data Access",id:"best-practices-for-data-access",level:3},{value:"Data Organization",id:"data-organization",level:4},{value:"Performance Optimization",id:"performance-optimization",level:4},{value:"Data Management",id:"data-management",level:4},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Common Issues",id:"common-issues",level:3},{value:"Performance Monitoring",id:"performance-monitoring",level:3},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const s={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components},{Details:n}=s;return n||function(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"shared-file-system-setup-for-sagemaker-hyperpod-eks",children:"Shared File System Setup for SageMaker HyperPod (EKS)"})}),"\n",(0,t.jsx)(s.h2,{id:"why-shared-file-systems-matter",children:"Why Shared File Systems Matter"}),"\n",(0,t.jsxs)(s.p,{children:["A high-performance shared file system is ",(0,t.jsx)(s.strong,{children:"critical"})," for achieving optimal performance in distributed machine learning workloads on SageMaker HyperPod. Without proper shared storage, your training jobs will be severely bottlenecked by data I/O operations."]}),"\n",(0,t.jsx)(s.h3,{id:"performance-impact",children:"Performance Impact"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Data Loading Bottlenecks"}),": Without shared storage, each pod must independently load training data, creating massive I/O overhead"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Checkpoint Synchronization"}),": Model checkpoints and intermediate results need fast, consistent access across all pods"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Memory Efficiency"}),": Shared file systems enable efficient data caching and reduce memory pressure on individual pods"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Scaling Limitations"}),": Local storage approaches fail to scale beyond single-pod training"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"fsx-for-lustre-benefits",children:"FSx for Lustre Benefits"}),"\n",(0,t.jsx)(s.p,{children:"Amazon FSx for Lustre is specifically designed for high-performance computing workloads and provides:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"High Throughput"}),": Up to hundreds of GB/s of aggregate throughput"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Low Latency"}),": Sub-millisecond latencies for small file operations"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"POSIX Compliance"}),": Standard file system semantics that work with existing ML frameworks"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"S3 Integration"}),": Seamless data repository associations with Amazon S3"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Elastic Scaling"}),": Storage capacity that can grow with your workload demands"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"setup-options",children:"Setup Options"}),"\n",(0,t.jsx)(s.h3,{id:"option-1-auto-provisioned-console-quick-setup",children:"Option 1: Auto-Provisioned (Console Quick Setup)"}),"\n",(0,t.jsxs)(s.p,{children:["When you create a HyperPod cluster through the AWS Console using the ",(0,t.jsx)(s.strong,{children:"Quick Setup"})," path, FSx for Lustre is automatically provisioned and configured for you."]}),"\n",(0,t.jsx)(s.h4,{id:"what-gets-created-automatically",children:"What Gets Created Automatically"}),"\n",(0,t.jsx)(s.p,{children:"The console automatically provisions:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"FSx for Lustre file system"})," with optimal performance settings"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Proper networking configuration"})," in the same VPC and subnet as your cluster"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Security group rules"})," allowing NFS traffic between cluster nodes and FSx"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"FSx CSI driver installation"})," for Kubernetes integration"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Storage classes and persistent volumes"})," ready for use in pods"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"IAM permissions"})," for the cluster to access the file system"]}),"\n"]}),"\n",(0,t.jsx)(s.h4,{id:"verification-steps",children:"Verification Steps"}),"\n",(0,t.jsxs)(s.p,{children:["After your cluster reaches ",(0,t.jsx)(s.code,{children:"InService"})," status, verify FSx is properly configured:"]}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Check FSx CSI driver installation"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-fsx-csi-driver\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Verify storage class"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl get storageclass | grep fsx\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Test with a sample pod"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:'cat <<EOF | kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: fsx-test\nspec:\n  containers:\n  - name: test\n    image: ubuntu\n    command: ["/bin/sh", "-c", "echo \'Hello FSx\' > /data/test.txt && cat /data/test.txt && sleep 3600"]\n    volumeMounts:\n    - name: fsx-storage\n      mountPath: /data\n  volumes:\n  - name: fsx-storage\n    persistentVolumeClaim:\n      claimName: fsx-claim\nEOF\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"option-2-manual-setup-dynamic-provisioning",children:"Option 2: Manual Setup (Dynamic Provisioning)"}),"\n",(0,t.jsx)(s.p,{children:"If you're creating your HyperPod cluster via CLI/SDK or want more control over your FSx configuration, you can manually set up dynamic provisioning."}),"\n",(0,t.jsx)(s.h4,{id:"when-to-use-manual-setup",children:"When to Use Manual Setup"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Custom performance requirements"}),": Need specific throughput or storage configurations"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Advanced networking"}),": Require custom VPC or subnet configurations"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Cost optimization"}),": Need precise control over storage capacity and performance tiers"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Integration requirements"}),": Want to integrate with existing Kubernetes storage workflows"]}),"\n"]}),"\n",(0,t.jsx)(s.h4,{id:"install-the-amazon-fsx-for-lustre-csi-driver",children:"Install the Amazon FSx for Lustre CSI Driver"}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.a,{href:"https://github.com/kubernetes-sigs/aws-fsx-csi-driver",children:"Amazon FSx for Lustre Container Storage Interface (CSI) driver"})," uses ",(0,t.jsx)(s.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html",children:"IAM roles for service accounts (IRSA)"})," to authenticate AWS API calls."]}),"\n",(0,t.jsx)(s.admonition,{title:"Performance Best Practice",type:"info",children:(0,t.jsx)(s.p,{children:"Make sure that your file system is located in the same Region and Availability Zone as your compute nodes. Accessing a file system in a different Region or Availability Zone will result in reduced I/O performance and increased network costs."})}),"\n",(0,t.jsx)(s.h4,{id:"step-by-step-setup",children:"Step-by-Step Setup"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Create an IAM OIDC identity provider"})," for your cluster:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"eksctl utils associate-iam-oidc-provider --cluster $EKS_CLUSTER_NAME --approve\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Create a service account"})," with an IAM role for the FSx CSI driver:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"eksctl create iamserviceaccount \\\n  --name fsx-csi-controller-sa \\\n  --namespace kube-system \\\n  --cluster $EKS_CLUSTER_NAME \\\n  --attach-policy-arn arn:aws:iam::aws:policy/AmazonFSxFullAccess \\\n  --approve \\\n  --role-name FSXLCSI-${EKS_CLUSTER_NAME}-${AWS_REGION} \\\n  --region $AWS_REGION\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Verify the service account"})," annotation:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl get sa fsx-csi-controller-sa -n kube-system -oyaml \n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Deploy the FSx CSI driver"})," using Helm:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm repo add aws-fsx-csi-driver https://kubernetes-sigs.github.io/aws-fsx-csi-driver\nhelm repo update\n\nhelm upgrade --install aws-fsx-csi-driver aws-fsx-csi-driver/aws-fsx-csi-driver \\\n  --namespace kube-system \\\n  --set controller.serviceAccount.create=false\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Verify CSI driver installation"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-fsx-csi-driver\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'---\nThe [Amazon FSx for Lustre CSI driver](https://github.com/kubernetes-sigs/aws-fsx-csi-driver) presents you with two options for provisioning a file system: \n\n#### Create Dynamic Provisioning Resources\n\nDynamic provisioning leverages Persistent Volume Claims (PVCs) in Kubernetes. You define a PVC with desired storage specifications, and the CSI Driver automatically provisions the FSx file system based on the PVC request.\n\n1. **Create a storage class** that leverages the `fsx.csi.aws.com` provisioner: \n\n```bash \ncat <<EOF> storageclass.yaml\nkind: StorageClass\napiVersion: storage.k8s.io/v1\nmetadata:\n  name: fsx-sc\nprovisioner: fsx.csi.aws.com\nparameters:\n  subnetId: $PRIVATE_SUBNET_ID\n  securityGroupIds: $SECURITY_GROUP_ID\n  deploymentType: PERSISTENT_2\n  automaticBackupRetentionDays: "0"\n  copyTagsToBackups: "true"\n  perUnitStorageThroughput: "250"\n  dataCompressionType: "LZ4"\n  fileSystemTypeVersion: "2.15"\nmountOptions:\n  - flock\nEOF\n'})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl apply -f storageclass.yaml\n"})}),"\n",(0,t.jsxs)(n,{children:[(0,t.jsx)("summary",{children:"Parameter Explanation"}),(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"privateSubnetId"})," - The subnet ID that the FSx for Lustre filesystem should be created inside. Using the ",(0,t.jsx)(s.code,{children:"$PRIVATE_SUBNET_ID"})," environment variable, we are referencing the same private subnet that was used for HyperPod cluster creation."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"securityGroupIds"})," - A list of security group IDs that should be attached to the filesystem. Using the ",(0,t.jsx)(s.code,{children:"$SECURITY_GROUP"})," environment variable, we are referencing the same security group that was use for HyperPod cluster creation."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"deploymentType"}),": ",(0,t.jsx)(s.code,{children:"PERSISTENT_2"})," is the latest generation of Persistent deployment type, and is best-suited for use cases that require longer-term storage, and have latency-sensitive workloads that require the highest levels of IOPS and throughput. For more information see ",(0,t.jsx)(s.a,{href:"https://docs.aws.amazon.com/fsx/latest/LustreGuide/using-fsx-lustre.html",children:"Deployment options for FSx for Lustre file systems"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"automaticBackupRetentionDays"}),": The number of days to retain automatic backups. Setting this value to 0 disables the creation of automatic backups. If you set this parameter to a non-zero value, you can also specify the preferred time to take daily backups using the dailyAutomaticBackupStartTime parameter."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"copyTagsToBackups"}),": If this value is true, all tags for the file system are copied to all automatic and user-initiated backups."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"perUnitStorageThroughput"}),": For ",(0,t.jsx)(s.code,{children:"PERSISTENT_2"})," deployments, you can specify the storage throughput in MBps per TiB of storage capacity."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"dataCompressionType"}),": FSx for Lustre supports data compression via the LZ4 algorithm, which is optimized to deliver high levels of compression without adversely impacting file system performance. For more information see ",(0,t.jsx)(s.a,{href:"https://docs.aws.amazon.com/fsx/latest/LustreGuide/data-compression.html",children:"Lustre data compression"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"fileSystemTypeVersion"}),": This sets the Lustre version for the FSx for Lustre file system that will be created."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"mountOptions"}),": A list of mount options for the file system. The ",(0,t.jsx)(s.code,{children:"flock"})," option mounts your file system with file lock enabled."]}),"\n"]}),"\n"]}),(0,t.jsxs)(s.p,{children:["You can find more information about storage class parameters in the ",(0,t.jsx)(s.a,{href:"https://github.com/kubernetes-sigs/aws-fsx-csi-driver/tree/master/examples/kubernetes/dynamic_provisioning#dynamic-provisioning-example",children:"aws-fsx-csi-driver GitHub repository"})]})]}),"\n",(0,t.jsxs)(s.ol,{start:"2",children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Verify the storage class"})," was created:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl get sc fsx-sc -oyaml\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Create a persistent volume claim (PVC)"}),":"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"cat <<EOF> pvc.yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: fsx-claim\n  namespace: default\nspec:\n  accessModes:\n    - ReadWriteMany\n  storageClassName: fsx-sc\n  resources:\n    requests:\n      storage: 1200Gi\nEOF\n"})}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsx)(s.p,{children:"PVCs are namespaced Kubernetes resources, so be sure to change the namespace as needed before creation."})}),"\n",(0,t.jsxs)(s.ol,{start:"4",children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Apply the PVC"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl apply -f pvc.yaml\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Monitor PVC status"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl get pvc fsx-claim -n default -w\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Wait for the status to change from ",(0,t.jsx)(s.code,{children:"Pending"})," to ",(0,t.jsx)(s.code,{children:"Bound"})," (~10 minutes while FSx is provisioned)."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Retrieve the FSx volume ID"})," (optional):"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"kubectl get pv $(kubectl get pvc fsx-claim -n default -ojson | jq -r .spec.volumeName) -ojson | jq -r .spec.csi.volumeHandle\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"option-3-bring-your-own-fsx-static-provisioning",children:"Option 3: Bring Your Own FSx (Static Provisioning)"}),"\n",(0,t.jsx)(s.p,{children:"If you have an existing FSx for Lustre file system, you can integrate it with your HyperPod cluster using static provisioning."}),"\n",(0,t.jsx)(s.h4,{id:"requirements-and-considerations",children:"Requirements and Considerations"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Network Requirements:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["FSx file system must be in the ",(0,t.jsx)(s.strong,{children:"same VPC"})," as your HyperPod cluster"]}),"\n",(0,t.jsxs)(s.li,{children:["FSx file system must be in the ",(0,t.jsx)(s.strong,{children:"same Availability Zone"})," as your cluster nodes"]}),"\n",(0,t.jsx)(s.li,{children:"Security groups must allow NFS traffic between cluster and FSx"}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Performance Considerations:"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Ensure FSx performance tier matches your workload requirements"}),"\n",(0,t.jsx)(s.li,{children:"Consider data locality - accessing FSx from different AZs reduces performance"}),"\n",(0,t.jsx)(s.li,{children:"Verify sufficient throughput capacity for your cluster size"}),"\n"]}),"\n",(0,t.jsx)(s.h4,{id:"integration-steps",children:"Integration Steps"}),"\n",(0,t.jsxs)(s.blockquote,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Note:"}),"\nBefore using an existing file system with the CSI driver on your EKS HyperPod cluster, please ensure that your FSx file system is in the same subnet (and thus, same Availability Zone) as your HyperPod cluster nodes."]}),"\n",(0,t.jsxs)(s.p,{children:["You can check the subnet of your HyperPod nodes by checking the ",(0,t.jsx)(s.code,{children:"$PRIVATE_SUBNET_ID"})," environment variable set as part of this cluster creation process."]}),"\n",(0,t.jsx)(s.p,{children:"To check the subnet ID of your existing file system, run"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"# Replace fs-xxx with your file system id\naws fsx describe-file-systems --file-system-id fs-xxx --query 'FileSystems[0].SubnetIds[]' --output text\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.blockquote,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Note:"}),"\nThe following YAMLs require variables that are not in our env_vars. To retrieve the variables, you can find them in your AWS console in ",(0,t.jsx)(s.code,{children:"FSx for Lustre"})," page, or you can run these commands:"]}),"\n",(0,t.jsx)(s.p,{children:"FSx For Lustre ID:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"aws fsx describe-file-systems --region $AWS_REGION | jq -r '.FileSystems[0].FileSystemId'\n"})}),"\n",(0,t.jsx)(s.p,{children:"FSx DNS Name:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"aws fsx describe-file-systems --region $AWS_REGION --file-system-id <fs-xxxx> --query 'FileSystems[0].DNSName' --output text\n"})}),"\n",(0,t.jsx)(s.p,{children:"FSx Mount Name:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"aws fsx describe-file-systems --region $AWS_REGION --file-system-id <fs-xxxx> --query 'FileSystems[0].LustreConfiguration.MountName' --output text\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Verify network compatibility"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"# Check your cluster's subnet and AZ\naws eks describe-cluster --name $EKS_CLUSTER_NAME --query 'cluster.resourcesVpcConfig.subnetIds'\n\n# Check your FSx file system's subnet and AZ  \naws fsx describe-file-systems --file-system-ids <your-fsx-id> --query 'FileSystems[0].SubnetIds'\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Get FSx file system details"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"# Get FSx ID, DNS name, and mount name\nFSX_ID=\"fs-xxxxx\"  # Replace with your FSx ID\n\naws fsx describe-file-systems --file-system-ids $FSX_ID \\\n  --query 'FileSystems[0].[FileSystemId,DNSName,LustreConfiguration.MountName]' --output table\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Create a StorageClass"})," for your existing FSx:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"cat <<EOF> storageclass.yaml\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: fsx-sc\nprovisioner: fsx.csi.aws.com\nparameters:\n  fileSystemId: $FSX_ID\n  subnetId: $PRIVATE_SUBNET_ID\n  securityGroupIds: $SECURITY_GROUP_ID\nEOF\n\nkubectl apply -f storageclass.yaml\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Create a PersistentVolume (PV)"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"cat <<EOF> pv.yaml\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: fsx-pv\nspec:\n  capacity:\n    storage: 1200Gi  # Adjust based on your FSx volume size\n  volumeMode: Filesystem\n  accessModes:\n    - ReadWriteMany\n  persistentVolumeReclaimPolicy: Retain\n  storageClassName: fsx-sc\n  csi:\n    driver: fsx.csi.aws.com\n    volumeHandle: $FSX_ID\n    volumeAttributes:\n      dnsname: <fsx-dns-name>  # Replace with your FSx DNS name\n      mountname: <fsx-mount-name>  # Replace with your FSx mount name\nEOF\n\nkubectl apply -f pv.yaml\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Create a PersistentVolumeClaim (PVC)"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"cat <<EOF> pvc.yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: fsx-claim\nspec:\n  accessModes:\n    - ReadWriteMany\n  storageClassName: fsx-sc\n  resources:\n    requests:\n      storage: 1200Gi  # Should match the PV size\nEOF\n\nkubectl apply -f pvc.yaml\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"using-fsx-in-eks-jobs",children:"Using FSx in EKS Jobs"}),"\n",(0,t.jsx)(s.h3,{id:"mount-points-and-paths",children:"Mount Points and Paths"}),"\n",(0,t.jsxs)(s.p,{children:["FSx for Lustre is accessed through Kubernetes Persistent Volume Claims (PVCs) and can be mounted at any path within your pods. The common pattern is to mount FSx volumes at ",(0,t.jsx)(s.code,{children:"/data"}),", ",(0,t.jsx)(s.code,{children:"/fsx"}),", or application-specific paths."]}),"\n",(0,t.jsx)(s.h3,{id:"best-practices-for-data-access",children:"Best Practices for Data Access"}),"\n",(0,t.jsx)(s.h4,{id:"data-organization",children:"Data Organization"}),"\n",(0,t.jsx)(s.p,{children:"Organize your FSx data structure for optimal access patterns:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"# Recommended FSx directory structure when mounted in pods\n/data/\n\u251c\u2500\u2500 datasets/           # Training datasets\n\u251c\u2500\u2500 checkpoints/        # Model checkpoints  \n\u251c\u2500\u2500 outputs/           # Training outputs and logs\n\u251c\u2500\u2500 code/              # Shared training scripts\n\u2514\u2500\u2500 scratch/           # Temporary files\n"})}),"\n",(0,t.jsx)(s.h4,{id:"performance-optimization",children:"Performance Optimization"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Use ReadWriteMany access mode"})," for shared access across multiple pods:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"accessModes:\n  - ReadWriteMany\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Leverage data caching"})," by pre-loading datasets:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"# Pre-load datasets to FSx before training\nkubectl run data-loader --image=amazon/aws-cli \\\n  --command -- aws s3 sync s3://your-bucket/dataset /data/datasets\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Optimize checkpoint frequency"})," to balance performance with fault tolerance:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:"# Save checkpoints to FSx, not local storage\ntorch.save(model.state_dict(), '/data/checkpoints/model_epoch_{}.pth'.format(epoch))\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h4,{id:"data-management",children:"Data Management"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Link FSx to S3"})," for data persistence:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"# Create data repository association\naws fsx create-data-repository-association \\\n  --file-system-id $FSX_ID \\\n  --file-system-path /datasets \\\n  --data-repository-path s3://your-bucket/datasets\n"})}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Use init containers"})," for data preparation:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"initContainers:\n- name: data-prep\n  image: amazon/aws-cli\n  command: ['aws', 's3', 'sync', 's3://bucket/data', '/data']\n  volumeMounts:\n  - name: fsx-storage\n    mountPath: /data\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(s.h3,{id:"common-issues",children:"Common Issues"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"PVC stuck in Pending state"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"# Check PVC events\nkubectl describe pvc fsx-claim\n\n# Check storage class\nkubectl get storageclass fsx-sc -o yaml\n\n# Verify CSI driver pods\nkubectl get pods -n kube-system -l app.kubernetes.io/name=aws-fsx-csi-driver\n"})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Pod mount failures"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"# Check pod events\nkubectl describe pod <pod-name>\n\n# Verify PVC is bound\nkubectl get pvc fsx-claim\n\n# Check FSx file system status\naws fsx describe-file-systems --file-system-ids <fsx-id>\n"})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Performance issues"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"# Monitor FSx metrics\naws cloudwatch get-metric-statistics \\\n  --namespace AWS/FSx \\\n  --metric-name TotalIOTime \\\n  --dimensions Name=FileSystemId,Value=$FSX_ID \\\n  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \\\n  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \\\n  --period 300 \\\n  --statistics Average\n"})}),"\n",(0,t.jsx)(s.h3,{id:"performance-monitoring",children:"Performance Monitoring"}),"\n",(0,t.jsx)(s.p,{children:"Monitor FSx performance through CloudWatch metrics:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"TotalIOTime"}),": I/O utilization percentage"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"DataReadBytes/DataWriteBytes"}),": Throughput metrics"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"MetadataOperations"}),": File system metadata operations"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,t.jsx)(s.p,{children:"Once your shared file system is set up:"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Test with sample workloads"})," to verify performance"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Configure data repository associations"})," with S3 if needed"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Set up monitoring and alerting"})," for FSx metrics"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Review the training blueprints"})," that leverage FSx for distributed training"]}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"For advanced FSx configuration and management, see:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/docs/Tips/Common/link-fsx-to-S3",children:"Link FSx to S3"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/docs/Tips/Common/mount-additional-fsx",children:"Mount additional FSx filesystems"})}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>a,x:()=>o});var i=n(6540);const t={},r=i.createContext(t);function a(e){const s=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(r.Provider,{value:s},e.children)}}}]);