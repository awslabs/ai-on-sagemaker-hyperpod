"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[894],{300:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/upload-to-s3-cc3d8d200f547529488f96d4542e9f27.png"},2589:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"Tips/Common/downsize-fsx","title":"Downsize existing FSx Volume","description":"Instructions to downsize an existing FSxL Filesystem using DRA import/export","source":"@site/docs/08-Tips/Common/17-downsize-fsx.md","sourceDirName":"08-Tips/Common","slug":"/Tips/Common/downsize-fsx","permalink":"/ai-on-sagemaker-hyperpod/docs/Tips/Common/downsize-fsx","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":17,"frontMatter":{"title":"Downsize existing FSx Volume","weight":57},"sidebar":"tutorialSidebar","previous":{"title":"Mount additional FSx Filesystem","permalink":"/ai-on-sagemaker-hyperpod/docs/Tips/Common/mount-additional-fsx"},"next":{"title":"FSx for Lustre Best practices","permalink":"/ai-on-sagemaker-hyperpod/docs/Tips/Common/Fsx for Lustre best practices"}}');var o=s(4848),i=s(8453);const r={title:"Downsize existing FSx Volume",weight:57},a=void 0,l={},c=[{value:"Instructions to downsize an existing FSxL Filesystem using DRA import/export",id:"instructions-to-downsize-an-existing-fsxl-filesystem-using-dra-importexport",level:3},{value:"1. Link existing filesystem to an S3 bucket in your account",id:"1-link-existing-filesystem-to-an-s3-bucket-in-your-account",level:4},{value:"2. Create a Data Repository Association for your existing FSx",id:"2-create-a-data-repository-association-for-your-existing-fsx",level:4},{value:"3. Create a Data Repository Export Task",id:"3-create-a-data-repository-export-task",level:4},{value:"4. Create a new FSx FileSystem which is right-sized:",id:"4-create-a-new-fsx-filesystem-which-is-right-sized",level:4},{value:"4a. Create file system for FSx",id:"4a-create-file-system-for-fsx",level:5},{value:"4b. Create Data Repostiory Association for your new FSxL filesytem",id:"4b-create-data-repostiory-association-for-your-new-fsxl-filesytem",level:5},{value:"5. Unmount existing FSxL from HyperPod Nodes.",id:"5-unmount-existing-fsxl-from-hyperpod-nodes",level:4},{value:"6. Mount new FSxL on Controller / Login Nodes",id:"6-mount-new-fsxl-on-controller--login-nodes",level:4},{value:"7. Unmount /fsx from the compute nodes using srun",id:"7-unmount-fsx-from-the-compute-nodes-using-srun",level:4},{value:"8. Mount new filesystem to compute nodes",id:"8-mount-new-filesystem-to-compute-nodes",level:4},{value:"9. Delete old FSx Lustre Filesystem",id:"9-delete-old-fsx-lustre-filesystem",level:4},{value:"10. Update HyperPod Lifecycle Scripts with new FSxL",id:"10-update-hyperpod-lifecycle-scripts-with-new-fsxl",level:4},{value:"11. [Optional / Recommended] Test node replacement",id:"11-optional--recommended-test-node-replacement",level:4}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.h3,{id:"instructions-to-downsize-an-existing-fsxl-filesystem-using-dra-importexport",children:"Instructions to downsize an existing FSxL Filesystem using DRA import/export"}),"\n",(0,o.jsxs)(t.p,{children:["These steps detail how to migrate from an existing FSxL filesystem to a smaller FSx FileSystem. There are several steps involved in this process, which uses FSxL DRA Export Policies to backup existing FileSystem to s3, then create a new FSxL Filesystem with a DRA Import policies to move old data to new FileSystem, and mount it to an existing Cluster. For more information, see the ",(0,o.jsx)(t.a,{href:"https://docs.aws.amazon.com/fsx/latest/LustreGuide/create-dra-linked-data-repo.html",children:"FSx Lustre guide on linking your filesystem to S3 bucket "}),"."]}),"\n",(0,o.jsx)(t.admonition,{type:"warning",children:(0,o.jsx)(t.p,{children:"You cannot downsize the storage size of an existing FSxL filesystem, hence the below method to migrate to a smaller FSxL filesystem is the alternative method"})}),"\n",(0,o.jsx)(t.h4,{id:"1-link-existing-filesystem-to-an-s3-bucket-in-your-account",children:"1. Link existing filesystem to an S3 bucket in your account"}),"\n",(0,o.jsx)(t.p,{children:"It is recommended to create a new S3 bucket in the desired region of your destination filesystem for this purpose:"}),"\n",(0,o.jsx)(t.p,{children:"To create a new bucket using the cli:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"aws s3api create-bucket --bucket <YOUR_DRA_BUCKET> --region <AWS_REGION> --create-bucket-configuration LocationCons\ntraint=<AWS_REGION>\n"})}),"\n",(0,o.jsx)(t.h4,{id:"2-create-a-data-repository-association-for-your-existing-fsx",children:"2. Create a Data Repository Association for your existing FSx"}),"\n",(0,o.jsxs)(t.p,{children:["In the FSx Lustre Console, go to your ",(0,o.jsx)(t.strong,{children:"existing Filesystem > Data Repository Assoications > Create"}),". Follow the below sample configuration:"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Users",src:s(5808).A+"",width:"1042",height:"1150"})}),"\n",(0,o.jsx)(t.admonition,{type:"warning",children:(0,o.jsxs)(t.p,{children:["Note: for filesystem path, it is recommended to set the root filesystem path of ",(0,o.jsx)(t.code,{children:"/"})," to ensure the entire filesystem is included in the DRA policy."]})}),"\n",(0,o.jsx)(t.h4,{id:"3-create-a-data-repository-export-task",children:"3. Create a Data Repository Export Task"}),"\n",(0,o.jsx)(t.p,{children:"Once your Data Repositary association is created, create a data repository task for that DRA. Follow the below sample configuration:"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"DRA Task Create",src:s(3436).A+"",width:"1378",height:"522"})}),"\n",(0,o.jsx)(t.p,{children:"Once created, you can view the status of your export task and view the Task status and total number of files processed by the task."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"DRA Task Status",src:s(7558).A+"",width:"1506",height:"853"})}),"\n",(0,o.jsx)(t.p,{children:'When the task has reached a status of "Succeeded", verify that the data has been successfully exported to your S3 bucket. You should see your root Filesystem directory stored in S3, similar to this example:'}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"S3 DRA",src:s(8397).A+"",width:"1401",height:"476"})}),"\n",(0,o.jsx)(t.h4,{id:"4-create-a-new-fsx-filesystem-which-is-right-sized",children:"4. Create a new FSx FileSystem which is right-sized:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"Create file system for FSx - Persistent SSD, same configuration (VPC, Subnet, Security Group) as old FileSystem."}),"\n",(0,o.jsx)(t.li,{children:"Create a DRA Import Policy targeting s3 bucket created in step 1"}),"\n"]}),"\n",(0,o.jsx)(t.h5,{id:"4a-create-file-system-for-fsx",children:"4a. Create file system for FSx"}),"\n",(0,o.jsx)(t.p,{children:"Create new FSx Persistent or Scratch filesystem, ensure proper VPC, Subnet, Security Group -reference existing filesystem, SG can be same SG as HyperPod cluster nodes in SageMaker console."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"FSxL Config",src:s(7358).A+"",width:"1376",height:"666"})}),"\n",(0,o.jsx)(t.h5,{id:"4b-create-data-repostiory-association-for-your-new-fsxl-filesytem",children:"4b. Create Data Repostiory Association for your new FSxL filesytem"}),"\n",(0,o.jsx)(t.p,{children:"Create a DRA Import Policy (and optional export policy) for your new Filesystem. Ensure you specify the path to the S3 bucket which you have backed up your existing Filesystem."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"DRA Create 2",src:s(6651).A+"",width:"1228",height:"1006"})}),"\n",(0,o.jsx)(t.h4,{id:"5-unmount-existing-fsxl-from-hyperpod-nodes",children:"5. Unmount existing FSxL from HyperPod Nodes."}),"\n",(0,o.jsxs)(t.p,{children:["For reference, see ",(0,o.jsx)(t.a,{href:"https://docs.aws.amazon.com/fsx/latest/LustreGuide/unmounting-fs.html",children:"FSx Lustre documentation for unmounting Filesystem"}),". Instructions also provided below:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"# on controller / login node of HyperPod cluster\n\n# Login as Root User\n$ sudo su  \n\n# cd to root directory \n$ cd \n\n#verify location as /root \npwd \n\n#should show /root\n"})}),"\n",(0,o.jsxs)(t.admonition,{type:"warning",children:[(0,o.jsx)(t.p,{children:"if you see the following error, you will need to logout of ubuntu user which is auto mounted on home directory"}),(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"root@ip-10-1-79-94:~# umount /fsx\numount: /fsx: target is busy.\n\n# $exit \n#sudo su \n#retry \n"})})]}),"\n",(0,o.jsx)(t.h4,{id:"6-mount-new-fsxl-on-controller--login-nodes",children:"6. Mount new FSxL on Controller / Login Nodes"}),"\n",(0,o.jsx)(t.p,{children:"Mount new FSxL on cluster controller / login node following commands in FSxL console. Run the command from FSxL console as root, once filesystem is successful. Note, we recommend waiting for the DRA task to execute successfully before continuing with this task."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Mount FSx",src:s(3793).A+"",width:"1604",height:"906"})}),"\n",(0,o.jsx)(t.h4,{id:"7-unmount-fsx-from-the-compute-nodes-using-srun",children:"7. Unmount /fsx from the compute nodes using srun"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"srun -N <NUM_COMPUTE_NODES> sudo umount /fsx\n"})}),"\n",(0,o.jsx)(t.h4,{id:"8-mount-new-filesystem-to-compute-nodes",children:"8. Mount new filesystem to compute nodes"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"srun -N <NUM_COMPUTE_NODES> sudo mount -t lustre ... (command from FSxL console)\n"})}),"\n",(0,o.jsx)(t.h4,{id:"9-delete-old-fsx-lustre-filesystem",children:"9. Delete old FSx Lustre Filesystem"}),"\n",(0,o.jsx)(t.p,{children:"Once you have confirmed the new filesystem is mounted and you can read files from it, proceed with deleting the old FSx Filesystem"}),"\n",(0,o.jsx)(t.h4,{id:"10-update-hyperpod-lifecycle-scripts-with-new-fsxl",children:"10. Update HyperPod Lifecycle Scripts with new FSxL"}),"\n",(0,o.jsxs)(t.p,{children:["Update ",(0,o.jsx)(t.code,{children:"provisioning_parameters.json"})," file in your sagemaker lifecycle bucket with new FSxL DNS and Mount Name."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Provisioning Parameters Update",src:s(6882).A+"",width:"1072",height:"634"})}),"\n",(0,o.jsxs)(t.p,{children:["Once updated, upload the new ",(0,o.jsx)(t.code,{children:"provisioning_parameters.json"})," file to your s3 bucket in the lifecycle script directory to overwrite the old ",(0,o.jsx)(t.code,{children:"provisioning_parameters.json"})," file. You can do so via the console (image below) or CLI."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Upload to S3",src:s(300).A+"",width:"1478",height:"747"})}),"\n",(0,o.jsx)(t.h4,{id:"11-optional--recommended-test-node-replacement",children:"11. [Optional / Recommended] Test node replacement"}),"\n",(0,o.jsxs)(t.p,{children:["After completing above steps, it is recommended to test that the new FSx Lustre defined in ",(0,o.jsx)(t.code,{children:"provisioning_parameters.json"})," is mounted to new cluster nodes upon HyperPod replacement actions. You can trigger a manual node replacement from the head/controller node with the below command:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:'sudo scontrol update node=<NODE-IP> state=down reason="Action:Replace"\n'})}),"\n",(0,o.jsx)(t.p,{children:"When the node comes back online, SSH into the node and confirm that FSx Lustre is properly mounted."})]})}function u(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},3436:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/DRA_Task_Create-d914d8b9cccd17f308de9d003483e6c5.png"},3793:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/mount-fsx-1-d1818c221390fe4029abf5ff5bd970fb.png"},5808:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/DRA_Create-b466f4d0e5c58f457071e3c05887ae88.png"},6651:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/DRA-create-2-e6dcf46c73456c235c31d357f9fc291f.png"},6882:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/prov_pram_update-069dc4651bd1d7a0c3e0163e01b37673.png"},7358:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/FSxL_config-decec25dd67404e592e472335b50eebe.png"},7558:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/DRA_task_status-5b957102f9d46d2355300c1fb0643d00.png"},8397:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/s3_dra-7adeae3f41fb1658a760f0b1dbefcd03.png"},8453:(e,t,s)=>{s.d(t,{R:()=>r,x:()=>a});var n=s(6540);const o={},i=n.createContext(o);function r(e){const t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);