"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9132],{2406:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>a});const o=JSON.parse('{"id":"Tips/Slurm/troubleshooting","title":"Troubleshooting","description":"So your cluster failed to create, what do you do now?","source":"@site/docs/08-Tips/Slurm/03-troubleshooting.md","sourceDirName":"08-Tips/Slurm","slug":"/Tips/Slurm/troubleshooting","permalink":"/ai-on-sagemaker-hyperpod/docs/Tips/Slurm/troubleshooting","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Troubleshooting","weight":43},"sidebar":"tutorialSidebar","previous":{"title":"Containers","permalink":"/ai-on-sagemaker-hyperpod/docs/Tips/Slurm/containers"},"next":{"title":"Bastion Host","permalink":"/ai-on-sagemaker-hyperpod/docs/Tips/Slurm/bastion-host"}}');var r=n(4848),t=n(8453);const l={title:"Troubleshooting",weight:43},i=void 0,c={},a=[{value:"DNS Error",id:"dns-error",level:2},{value:"Logs",id:"logs",level:2}];function d(e){const s={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsx)(s.p,{children:"So your cluster failed to create, what do you do now?"}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["The first thing to look at is the status reason. This ",(0,r.jsx)(s.strong,{children:"only"})," shows up in the API/CLI and not the console so you'll need to run:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"aws sagemaker describe-cluster --cluster-name\n"})}),"\n",(0,r.jsxs)(s.p,{children:["In that call you'll see a ",(0,r.jsx)(s.em,{children:"FailureMessage"})," field such as:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:'"FailureMessage": "We currently do not have sufficient capacity for the requested instance type(s). Please try again.",\n'})}),"\n",(0,r.jsxs)(s.admonition,{type:"info",children:[(0,r.jsxs)(s.p,{children:["If you get the above error message it's usually because you're running the wrong ",(0,r.jsx)(s.em,{children:"availability zone"}),". Try launching the same instance type in that Availability Zone in native EC2. Our stack defaults to ",(0,r.jsx)(s.code,{children:"usw2-az4"})," which does not support ",(0,r.jsx)(s.code,{children:"g5.12xlarge"}),". Please use ",(0,r.jsx)(s.code,{children:"usw2-az3"})," or ",(0,r.jsx)(s.code,{children:"usw2-az2"})," for that. To determine supported AZ's you can run the following command for your instance type:"]}),(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"aws ec2 describe-instance-type-offerings --location-type availability-zone  --filters Name=instance-type,Values=g5.12xlarge --region us-west-2 --output table\n"})})]}),"\n",(0,r.jsx)(s.p,{children:"Or"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:'"Lifecycle scripts did not run successfully. Ensure the scripts exist in provided S3 path, are accessible, and run without errors. Please see CloudWatch logs for lifecycle script execution details."\n'})}),"\n",(0,r.jsx)(s.h2,{id:"dns-error",children:"DNS Error"}),"\n",(0,r.jsxs)(s.p,{children:["If you see the following error when running a Slurm command such as ",(0,r.jsx)(s.code,{children:"srun"}),", ",(0,r.jsx)(s.code,{children:"sbatch"})," or ",(0,r.jsx)(s.code,{children:"sinfo"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"$ srun ...\nsrun: error: resolve_ctls_from_dns_srv: res_nsearch error: Unknown host\nsrun: error: fetch_config: DNS SRV lookup failed\nsrun: error: _establish_config_source: failed to fetch config\nsrun: fatal: Could not establish a configuration source\n"})}),"\n",(0,r.jsxs)(s.p,{children:["This is likely caused by restarting the ",(0,r.jsx)(s.code,{children:"slurmd"})," process on the Headnode. If you accidently ran ",(0,r.jsx)(s.code,{children:"sudo systemctl restart slurmd"})," on the headnode it'll delete the ",(0,r.jsx)(s.code,{children:"/opt/slurm/etc/slurm.conf"})," file. This is recoverable by running the following commands:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"sudo systemctl stop slurmd && sleep 1\nsudo systemctl stop slurmctld && sleep 1\nsudo systemctl stop sagemaker-cluster-agent && sleep 1\nsudo systemctl start sagemaker-cluster-agent && sleep 1\nsudo systemctl start slurmctld && sleep 1\n"})}),"\n",(0,r.jsx)(s.p,{children:"Additionally, you will need to restore slurm accounting on the controller node with the following steps:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'echo -e "\\n# ACCOUNTING\\nInclude accounting.conf" | sudo tee -a "/opt/slurm/etc/slurm.conf"\nsudo scontrol reconfigure\nsudo systemctl restart slurmctld\n'})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Note"})," To restart the ",(0,r.jsx)(s.em,{children:"slurm scheduler"})," on the head node run ",(0,r.jsx)(s.code,{children:"sudo systemctl restart slurmctld"}),". This is the scheduler process and ",(0,r.jsx)(s.code,{children:"slurmd"})," is the compute node process."]}),"\n",(0,r.jsx)(s.h2,{id:"logs",children:"Logs"}),"\n",(0,r.jsx)(s.p,{children:"If the Lifecycle scripts failed, you'll need to look at CloudFormation logs."}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["Go to ",(0,r.jsx)(s.a,{href:"https://console.aws.amazon.com/cloudwatch/home?#logsV2:log-groups",children:"Cloudformation Logs"})]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["Search for ",(0,r.jsx)(s.code,{children:"/aws/sagemaker/Clusters/<cluster-name>/<cluster-id>"})]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["There's a log group per-instance launched. I suggest looking at the Head Node (",(0,r.jsx)(s.code,{children:"controller-group"}),") first:"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"CloudWatch Logs",src:n(3451).A+"",width:"1358",height:"368"})}),"\n"]}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},3451:(e,s,n)=>{n.d(s,{A:()=>o});const o=n.p+"assets/images/logs-cff7f91d7e8d2d43482e496fdb3995e3.png"},8453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>i});var o=n(6540);const r={},t=o.createContext(r);function l(e){const s=o.useContext(t);return o.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),o.createElement(t.Provider,{value:s},e.children)}}}]);